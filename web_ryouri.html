<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CSV → 料理ビュー</title>
  <style>
    :root{
      --border:#cfcfcf;
      --bg:#ffffff;
      --muted:#666;
      --shadow: 0 1px 3px rgba(0,0,0,.12);
      --cardW: 320px;
      --iframeH: 280px;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background:#f6f6f6;
      margin:0;
      padding:24px;
      color:#111;
    }
    header{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    h1{
      font-size:18px;
      margin:0;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .drop{
      border:2px dashed var(--border);
      background:var(--bg);
      padding:10px 12px;
      border-radius:10px;
      box-shadow: var(--shadow);
      min-width: 320px;
    }
    .drop.dragover{
      border-color:#2b7cff;
      background:#eef5ff;
    }
    .drop small{ color:var(--muted); display:block; margin-top:4px; }
    .btn{
      border:1px solid var(--border);
      background:var(--bg);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      box-shadow: var(--shadow);
    }
    .btn:hover{ border-color:#888; }
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(var(--cardW), 1fr));
      gap:16px;
      align-items:start;
    }
    .card{
      background:var(--bg);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{
      padding:10px 12px 6px;
      border-bottom:1px solid #eee;
    }
    .title{
      font-weight:700;
      font-size:16px;
      margin:0 0 4px;
      line-height:1.25;
    }
    .meta{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
    }
    .stars{
      font-size:13px;
      color:#111;
    }
    .link{
      display:block;
      padding:8px 12px;
      font-size:12px;
      color:#0b57d0;
      text-decoration:none;
      word-break:break-all;
      border-bottom:1px solid #eee;
      background:#fafafa;
    }
    .preview{
      position:relative;
      width:100%;
      height:var(--iframeH);
      background:#111;
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
      background:white;
    }
    .blocked{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      text-align:center;
      color:#fff;
      background:linear-gradient(135deg, rgba(0,0,0,.7), rgba(0,0,0,.85));
      font-size:13px;
    }
    .blocked a{ color:#9ad1ff; }
    .footer{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }
    .row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    input[type="file"]{ display:none; }
    .pill{
      border:1px solid var(--border);
      padding:6px 10px;
      border-radius:999px;
      background:#fff;
      font-size:12px;
      color:#333;
      box-shadow: var(--shadow);
    }
  </style>
</head>
<body>
  <header>
    <h1>CSV → 料理ビュー（カード表示）</h1>
    <div class="controls">
      <label class="btn" for="file">CSVを選択</label>
      <input id="file" type="file" accept=".csv,text/csv" />
      <button class="btn" id="loadSample">サンプル読み込み</button>
      <span class="pill" id="count">0 件</span>
    </div>
  </header>

  <div class="drop" id="drop">
    ここにCSVをドラッグ&ドロップ
    <small>形式: <code>#,料理名,評価,URL</code>（ヘッダ行あり）</small>
  </div>

  <div style="height:14px"></div>

  <main class="grid" id="grid"></main>

  <div class="footer">
    <strong>注意:</strong> 一部サイトはセキュリティ設定により埋め込み(iframe)がブロックされ、プレビューが表示できません。その場合はリンクから別タブで開いてください。
  </div>

<script>
  // ---- かんたんCSVパーサ（ダブルクォート対応、カンマ区切り）----
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let cur = '';
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i+1];

      if (c === '"' ) {
        if (inQuotes && next === '"') { // "" -> "
          cur += '"'; i++;
        } else {
          inQuotes = !inQuotes;
        }
      } else if (c === ',' && !inQuotes) {
        row.push(cur); cur = '';
      } else if ((c === '\n' || c === '\r') && !inQuotes) {
        if (c === '\r' && next === '\n') i++;
        row.push(cur); cur = '';
        if (row.some(v => v.trim() !== '')) rows.push(row);
        row = [];
      } else {
        cur += c;
      }
    }
    // last
    row.push(cur);
    if (row.some(v => v.trim() !== '')) rows.push(row);
    return rows;
  }

  function normalizeHeaders(headers){
    // 例: "#", "料理名", "評価", "URL"
    const map = {};
    headers.forEach((h, idx) => map[h.trim()] = idx);
    return map;
  }

  function starText(n){
    const num = Math.max(0, Math.min(5, parseInt(n,10) || 0));
    // 「星5」表記 + 視覚用の★
    const stars = "★★★★★☆☆☆☆☆".slice(5-num, 10-num); // 5文字
    return { label: `星 ${num}`, stars };
  }

  function render(items){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    document.getElementById('count').textContent = `${items.length} 件`;

    for (const it of items){
      const { label, stars } = starText(it.rating);

      const card = document.createElement('section');
      card.className = 'card';

      const head = document.createElement('div');
      head.className = 'card-head';
      head.innerHTML = `
        <p class="title">${escapeHtml(it.title || '')}</p>
        <div class="meta">
          <span class="stars">${escapeHtml(label)}（${escapeHtml(stars)}）</span>
          <span>#${escapeHtml(it.no || '')}</span>
        </div>
      `;

      const a = document.createElement('a');
      a.className = 'link';
      a.href = it.url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.textContent = it.url;

      const preview = document.createElement('div');
      preview.className = 'preview';

      const frame = document.createElement('iframe');
      frame.loading = 'lazy';
      frame.referrerPolicy = 'no-referrer-when-downgrade';
      frame.src = it.url;

      // ブロック判定は完全にはできないが、ロードが進まない/エラーっぽい時の案内を上に置く
      const blocked = document.createElement('div');
      blocked.className = 'blocked';
      blocked.innerHTML = `
        <div>
          <div style="font-weight:700; margin-bottom:6px;">プレビューを表示できない可能性があります</div>
          <div style="opacity:.9; margin-bottom:8px;">
            サイト側が埋め込みを禁止している場合、ここは表示されません。
          </div>
          <div>
            <a href="${escapeAttr(it.url)}" target="_blank" rel="noopener noreferrer">別タブで開く</a>
          </div>
        </div>
      `;

      // 3秒後に案内を表示（表示できるサイトでも上に重なるので、ロードできたら非表示にする）
      let timer = setTimeout(() => blocked.style.display = 'flex', 1200);

      frame.addEventListener('load', () => {
        // loadイベントが来れば大抵は表示できているので案内を消す
        clearTimeout(timer);
        blocked.style.display = 'none';
      });

      preview.appendChild(frame);
      preview.appendChild(blocked);

      card.appendChild(head);
      card.appendChild(a);
      card.appendChild(preview);
      grid.appendChild(card);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escapeAttr(s){
    return String(s).replace(/"/g, '&quot;');
  }

  function csvToItems(text){
    const rows = parseCSV(text.trim());
    if (!rows.length) return [];
    const header = rows[0].map(x => x.trim());
    const idx = normalizeHeaders(header);

    // ヘッダがないケースも想定（先頭行が数字ならヘッダなし扱い）
    const hasHeader = header.includes('料理名') && header.includes('評価') && header.includes('URL');

    const dataRows = hasHeader ? rows.slice(1) : rows;
    const items = [];

    for (const r of dataRows){
      // ヘッダありならキーで、なしなら固定位置
      const no = hasHeader ? r[idx['#']] : r[0];
      const title = hasHeader ? r[idx['料理名']] : r[1];
      const rating = hasHeader ? r[idx['評価']] : r[2];
      const url = hasHeader ? r[idx['URL']] : r[3];

      if (!url) continue;
      items.push({ no, title, rating, url });
    }
    return items;
  }

  // ---- UI: ファイル選択 & DnD ----
  const fileInput = document.getElementById('file');
  fileInput.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const text = await f.text();
    render(csvToItems(text));
  });

  const drop = document.getElementById('drop');
  drop.addEventListener('dragover', (e) => {
    e.preventDefault();
    drop.classList.add('dragover');
  });
  drop.addEventListener('dragleave', () => drop.classList.remove('dragover'));
  drop.addEventListener('drop', async (e) => {
    e.preventDefault();
    drop.classList.remove('dragover');
    const f = e.dataTransfer.files?.[0];
    if (!f) return;
    const text = await f.text();
    render(csvToItems(text));
  });

  // ---- サンプル ----
  document.getElementById('loadSample').addEventListener('click', () => {
    const sample = `#,料理名,評価,URL
1,手羽元のグリル,5,https://cookpad.com/jp/recipes/20797856
2,煮物,3,https://gyousu.love/sauce-for-simmered-food/
3,いわしのトマト煮込み,2,https://cookpad.com/jp/recipes/21448718`;
    render(csvToItems(sample));
  });
</script>
</body>
</html>
``